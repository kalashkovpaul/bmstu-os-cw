\section{\large Аналитическая часть}

В данном разделе проводится анализ действий, которые должна предотвращать разрабатываемая программа, а также структур ядра, необходимых для реализации загружаемого модуля.

\subsection{Анализ предотвращаемых действий}

Для того, чтобы разработать необходимую программу, требуется проанализировать выполнение в ОС Linux следующих действий:
\begin{itemize}[leftmargin=1.6\parindent]
	\item[---] использование привилегий root аккаунта;
	\item[---] запись в в файл; 
	\item[---] перемещение и переименование файла;
	\item[---] удаление файла;
	\item[---] изменение владельца файла и группы пользователей файла.
\end{itemize}

Анализ данных действий и дальнейшая работа будет производиться на основе дистрибутива Ubuntu 22.04, в основе которого лежит ядро Linux версии 5.16.0 для процессоров x86\_64.

\subsubsection{Использование привилегий root}

root аккаунт (root-пользователь, суперпользователь) --- аккаунт, у которого есть доступ ко всем командам и файлам системы.  Привилегии root --- возможности взаимодействия с системой, которые даёт root-аккаунт. root аккаунт обладает абсолютным контролем над системой: он имеет полный доступ ко всем файлам и командам, может изменять систему любым желаемым способом, а также разрешать или запрещать доступ к файлам другим пользователям системы (доступ на чтение, доступ на запись и доступ на исполнение файла) \cite{root-definition}.

Существует команда sudo, позволяющая дать пользователю или группе пользователей временные (по умолчанию 5 минут) привилегии root аккаунта. Чтобы использовать данную команду, необходимо написать sudo, после чего написать команду, которую необходимо исполнить с использованием root-прав.

Таким образом, реализуемая программа должна защищать указанный файл от воздействия команд, исполненных как без использования sudo, так и с использованием.

\subsubsection{Запись в файл}

В ОС Linux запись в файл, а также команды и программы, в той или иной мере изменяющие файл (команда перенаправления ввода-вывода, текстоовые редакторы) используют функцию write, имеющую заголовок, представленный на листинге \ref{code:write-header}.
\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Заголовок функции write}
	\label{code:write-header}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/write.c}
\end{code}

Функция write записывает count байт из буфера, начинающегося по указателю buf в открытый файл с дескриптором fd \cite{write-manual}.

Таким образом, чтобы предотвратить запись в указанный файл, необходимо предотвратить открытие данного файла в режиме записи. Для этого необходимо провести анализ структур ядра, при помощи которых описывается открытый файл.

\subsubsection{Перемещение и переименования файла}

Перемещение и переименование файла в ОС Linux может быть осуществлено при помощи команды mv, варианты использования которой приведены в листинге \ref{code:write-header}.

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Варианты использования команды mv}
	\label{code:mv-example}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/mv_example.txt}
\end{code}

Если последний аргумент является именем существующего каталога, то mv перемещает все остальные файлы в этот каталог. В противном случае, если задано только два файла, то имя первого файла будет изменено на имя второго. Если последний аргумент не является каталогом и задано более чем два файла, то будет выдано сообщение об ошибке \cite{mv-manual}.

Так, mv /a/x/y /b переименует файл /a/x/y в /b/y, если /b является существующим каталогом, и в /b, если нет.

Для предотвращения перемещения и переименования указанного файла необходимо проанализировать структуры ядра, при помощи которых описывается элементы пути в файловой системе.

\subsubsection{Изменение владельцев и группы пользователей файла}

Для каждого объекта (файла, каталога, ссылки) в Linux и других Unix-подобных ОС действует система доступов \cite{permission-definition}. Каждый объект обладает тремя типами доступов: доступ на чтение, доступ на запись (модификацию) и доступ на выполнение. 

Каждый из этих доступов определён для трёх категорий пользователей:  
\begin{itemize}[leftmargin=1.6\parindent]
	\item[---] владелец;
	\item[---] группа пользователей (т.~е. набор пользователей, обладающих одинаковыми правами доступа), к которой принадлежит владелец файла; 
	\item[---] все остальные пользователи.
\end{itemize}

Доступы для конкретного файла могут быть представлены разными спсобами, один из них --- текстовый, который предоставляет команда ls с опцией -l. В этом случае доступы представляются в виде 10-символьной строки, первый символ которой обозначает тип файла (например, дефис для обычного файла и \textit{d} для каталога), а оставшиеся 9 символов состоят из трёх групп по 3 символа, представляющих доступы на чтение (символ \textit{r} в случае наличия доступа), запись (символ \textit{w}) и выполнение (символ \textit{x}). В случае, если конкретного доступа нет, символом будет дефис.

Так, строка \textit{-rwxrw-r-\--}, возвращаемая для объекта командой \textit{ls - l} будет означать, что объект является обычным файлом, его владелец имеет доступ на чтение, запись, и выполнение, группа пользователей имеет доступ на чтение и запись, а все остальные пользователи имеют доступ только на чтение.

Доступы также могут быть представлены в численном виде как три восьмеричных числа. Значения этих чисел определены следующим образом: 0 для запрета всех типов доступа, 1 для доступа только на выполнение, 2 для доступа только на запись, 3 для доступа на запись и выполнение, 4 для доступа только на чтение, 5 для доступа на чтение и выполнение, 6 для доступа на чтение и запись, 7 для доступа на чтение, запись и выполнение.

Так, число 777 будет означать, что все пользователи имеют все доступы к данному файлу.

Для изменения доступов к конкретному файлу существует команда chmod, которая принимает необходимые доступы в численном или текстовоом виде, команда chown, меняющая владельца файла и команда chgrp, изменяющая группу пользователей файла.

Таким образом, для предотвращения изменения доступов к файлу (в том числе владельца файла и группы пользователей файла) необходимо проанализироовать структуры ядра, описывающие доступы к конкретному файлу.

\subsection{Анализ структур ядра}

Рассмотрим структуры ядра (ядро Linux версии 5.16.0), описывающие открытый файл и элемент пути в файловой системе. 

\subsubsection{struct inode}

inode --- структура ядра Linux, описывающая открытый файл. Она содержит в себе информацию, необходимую ядру для действий, связанных с файлом. На листингах \ref{code:inode-1}--\ref{code:inode-4} представлена структура inode с комментариями отдельных полей \cite{inode-code}.

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура inode, часть 1}
	\label{code:inode-1}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/inode-1.c}
\end{code}

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура inode, часть 2}
	\label{code:inode-2}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/inode-2.c}
\end{code}

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура inode, часть 3}
	\label{code:inode-3}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/inode-3.c}
\end{code}

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура inode, часть 4}
	\label{code:inode-4}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/inode-4.c}
\end{code}

%Поле i\_flags, содержащее флаги файловой системы, позволяет определить возможность изменения прав доступа для описываемого файла. Существует флаг FS\_IMMUTABLE\_FL, запрещающий изменение полей i\_uid, i\_gid, а также i\_mode. Установка данного флага позволит предотвратить изменение владельца файла, групппы пользователей файла, а также доступы к файлу.

Для предотвращения опрерации открытия файла в режиме записи, а также самой записи необходимо изменить содержимое поля i\_fop. Структура \linebreak file\_operations содержит 4 поля, имеющих значение для поставленной задачи (листинг \ref{code:file-operations}).

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура file\_operations}
	\label{code:file-operations}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/file_operations.c}
\end{code}

Структура file\_operations содержит поля read и write, в которых хранятся указатели на функции, вызывающиеся для чтения и записи данных соответственно. Также в ней содержатся поля read\_iter и write\_iter, содержащие указатели на функции, вызывающиеся перед read и write соответственно. Для предотвращения записи в файл необходимо переопределить значение поля write\_iter таким образом, чтобы в случае, когда запись возможна, возвращался флаг \linebreak EACCES, означающий запрет на запись.

Для предотвращения открытия файла в режиме записи необходимо переопределить значение поля open таким образом, чтобы в случае открытия файла на чтение работа осуществлялась без изменений, а в случае открытия файла на запись возвращался флаг EACCES.

Для предотвращения изменений доступов к файлу, владельца файла и группы пользователей файла необходимо обратиться к полю i\_op в inode. В нём есть поле setattr, содержащее указатель на функцию изменения таких атрибутов inode, как i\_uid, i\_gid, а также i\_mode (листинг \ref{code:inode-operations}).

\clearpage

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура inode\_operations}
	\label{code:inode-operations}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/inode_operations.c}
\end{code}

Для корректной работы разрабатываемого модуля ядра необходимо, чтобы после выгрузки модуля значения изменённых полей возвращались обратно. Для этого необходимо предусмотреть сохранение исходных объектов полей i\_fop и i\_op.

\subsubsection{struct dentry}

dentry --- структура ядра Linux, описывающая элемент пути в файловой системе.  При таких операциях, как переименование и перемещение файла, взаимодействие происходит именно с объектами dentry, а не с inode. В листингах \ref{code:dentry-1}--\ref{code:dentry-1} представлена структура dentry с комментариями полей \cite{dentry-code}.

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура dentry, часть 1}
	\label{code:dentry-1}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/dentry-1.c}
\end{code}

\begin{code}
	\captionsetup{justification=centering}
	\captionof{listing}{Структура dentry, часть 2}
	\label{code:dentry-2}
	\inputminted
	[
	frame=single,
	framerule=0.5pt,
%	framesep=20pt,
	fontsize=\small,
	tabsize=4,
	linenos,
	numbersep=5pt,
	xleftmargin=10pt,
	]
	{text}
	{/Users/p.kalashkov/Desktop/seventhTerm/bmstu-os-cw/docs/code/dentry-2.c}
\end{code}


Поле d\_flags, содержащее флаги файловой системы, позволяет определить возможность изменения прав доступа для описываемого файла. Существует флаг FS\_IMMUTABLE\_FL, запрещающий изменение полей i\_uid, i\_gid, а также i\_mode у inode, указатель на который содержится в поле d\_inode. Установка данного флага позволит предотвратить изменение владельца файла, групппы пользователей файла, а также доступы к файлу.

После выгрузки разрабатываемого модуля ядра необходимо, чтобы значение поля d\_flags устанавливалось в исходное значение.


\subsubsection{Регистры процессоров Intel}

Страницы памяти, в которых хранятся структуры file\_operations и \linebreak inode\_operations помечены как read-only. В процессорах, построенных по архитектуре x86, существует понятие регистров контроля (англ. \textit{Control Registers, CR}), которые содержат значения флагов, относящихся к защите памяти, многопоточности, разбиению памяти на страницы и т.~д. \cite{intel-manual}. 16-й бит регистра контроля CR0 отвечает за возможность изменения страниц, помеченных как read-only в режиме суперпользователя. Когда он установлен, суперпользователь не может изменять страницы, помеченные как read-only.

На некоторых процессорах x86 прозводства Intel данный бит по умолчанию установлен, поэтому прежде чем заменять значения полей i\_op и i\_fop на новые, необходимо выключить данный флаг и установить его в исходное значение после выполнения необходимых операций.

Для улучшения безопасности регистры CR0 и CR4 в ОС Linux c версии 5.3 являются защищёнными, и функция write\_cr0, с помощью которой можно было установить значение регистра CR0, уже не входит в набор предоставляемых разработчикам функций. Необходимо найти альтернативный способ установки значения регистра CR0 при помощи ассемблерных вставок из загружаемого модуля ядра.

\subsection*{Вывод}
В данном разделе был проведён анализ действий, которые должна предотвращать разрабатываемая программа, а также структур ядра, необходимых для реализации загружаемого модуля.
Определены действия, которые необходимо предотвращать: команды записи (использование вызова write и текстовго редактора), команд chmod, chown и chgrp, изменяющих доступы к файлу, а также команды mv, перемещающей или переименовывающей файл. Данные действия необходимо предотвращать, даже если они выполнены при помощи команды sudo, дающей привилегии суперпользователя.

Для предотвращения открытия и записи в файл необходимо переопределить исходные значения полей open и write\_iter структуры file\_operations в поле i\_fop у inode, относящегося к файлу.
Для предотвращения изменения доступа к файлу, а также владельца файла и группы пользователей, необходимо переопределить заначение поля setattr структуры inode\_operations в поле i\_op того же inode.

Для предотвращения перемещения и переименования файла необходимо обеспечить неизменяемость соответствующего файлу объекта dentry при помощи установки флага FS\_IMMUTABLE\_FL в поле d\_flags.

Для корректной работы программы необходимо обеспечить работу с регистром контроля CR0 при помощи ассеммблерных вставок для возможности изменить необходимые поля у inode. При выгрузке разработанного модуля ядра значения изменённых полей должны возвращаться к исходным.

